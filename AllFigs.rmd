---
---
---

# Creation of All Figures

## Figure 1.1: Map of Analysed Project Areas

**Sources:**

1.  GADM. (2021). GADM database of Global Administrative Areas. Version 3.6. <https://gadm.org>

2.  Pante E, Simon-Bouhet B, Irisson J (2023). \_marmap: Import, Plot and Analyze Bathymetric and Topographic Data\_. R  package version 1.0.10, <https://CRAN.R-project.org/package=marmap>.

3.  GIS Data: <https://www.boem.gov/renewable-energy/mapping-and-data/renewable-energy-gis-data> 

```{r setup, warning=FALSE, message=FALSE, tidy=TRUE,cache=FALSE}
library(sf)
library(ggplot2)
library(dplyr)
library(raster)
library(gstat)
library(ggrepel)
library(metR)
library(ggpattern)
library(marmap)

#Grabbing Shapefiles
shapefile <- st_read("./ShapeFiles/Wind_Lease_Outlines_2_2023_carto_upgrade.shp", quiet = TRUE)
BIShape <- st_read("./ShapeFiles/BlockIslandRenewableEnergyZone-polygon.shp", promote_to_multi=TRUE, crs = 4326, quiet = TRUE)

#Trimming
BIShape <- BIShape[, 8]
greyShapes <- shapefile

#Selecting the 12 projects we analysed
shapefile <- shapefile[c(16, 19, 13, 9, 17, 8, 10, 25, 22, 14, 18), 'geometry']

#Adding Project Names
shapefile$Name <- names<-c("Vineyard Wind", "South Fork", "Ocean Wind 1", "Revolution Wind", "Kittyhawk", "Coastal Virginia", "Sunrise Wind", "New England Wind", "Mayflower / South Coast", "Atlantic Shores South", "Empire Wind")
BIShape$Name <- "Block Island"

#Binding BIW to the rest
shapefile <- rbind(shapefile, BIShape)

#Finding the Conter
shapefile$Cords <- st_coordinates(st_centroid(shapefile))

#Grabbing US Outline
east_coast <- st_as_sf(raster::getData("GADM", country = "USA", level = 1))

#Getting Bathimetric Info
b2 <- getNOAA.bathy(lat1 = 42.1, lon1 = -69.4, lat2 = 35.8 , lon2 = -77.1, resolution = 2)
b2f <- tibble(fortify.bathy(b2))
bathy_sf <- st_as_sf(b2f, coords = c("x", "y"), agr = "constant", crs = 4326)

#Grapphing
map <- ggplot(shapefile)+
  geom_contour2(data = b2f, aes(x, y, z=z, label = after_stat(level)), color = 'black', breaks = c(-50, -100, -250, -1000, -2000, -4000), linewidth = .1)+
  geom_sf(data = east_coast, fill = "#a5b3c7")+
  theme_void()+
  geom_sf(data = greyShapes, aes(geometry = geometry), fill = 'red', alpha = 0.2)+
  geom_sf(aes(fill = Name))+
  #geom_text_repel(aes(x = shapefile$Cords[,"X"], y = shapefile$Cords[,"Y"], label = shapefile$PROJECT_NA))+
  coord_sf(ylim = c(35.8, 42.1),
           xlim = c(-77.1, -69.4))+
  labs(title = NULL, fill = NULL)

#Saving Figure
ggsave("./SavedFigs/Fig1_1.png", map, height = 10, width = 6, dpi = 300)
map
```

## Figure 1.2 Time Line Of Analysed Projects

All Project Dates Taken from BOEM Website of State Renewable Energy Activities

```{r, warning=FALSE, message=FALSE, tidy=TRUE,cache=FALSE}
library(ggplot2)
library(openxlsx) 
library(patchwork)
library(dplyr)
library(stringr)
library(lubridate)
library(readxl)
library(gtable)
library(gridExtra)

#Grabbing Data 4 timeline
data <- read_excel("./TimeLine.xlsx", sheet = 1) #Time Line Data
dataRef <- read_excel("./TimeLine.xlsx", sheet = 2) #Sizes/Colors
metaData <- read_excel("./ClassificationData.xlsx", sheet = 2) #prj MetaData

#Changing to Date type
data$start <- as.Date(data$start)

#Factorizing by SAP start Date Order
data$group <- factor(data$group, levels = c("Coastal Virginia", "Revolution Wind",'South Fork',  "Vineyard Wind", "Ocean Wind 1", "New England Wind", "Empire Wind", "Kittyhawk", "Sunrise Wind", "Atlantic Shores South", "Mayflower / South Coast"))

#Factorizing by Project Development - for Legend
data$color<-factor(data$color, levels = c("SAP","COP Submit", "NOI EIS", "DEIS Release", "FEIS Release", "ROD Release", "COP Approval", "COP Update", "COP Other", "Comment End", "Other" ))

#Sizing Dots
data$size <- dataRef$Size[match(data$color, dataRef$Tags)]

#Adding Long Names
matchdf <- data.frame(
  nameLong = c("Vineyard Wind", "South Fork", "Ocean Wind 1", "Revolution Wind", "Kittyhawk", "Coastal Virginia", "Sunrise Wind", "New England Wind", "Mayflower / South Coast", "Atlantic Shores South", "Empire Wind"),
  nameShort = c("YVW", "SFR", "OWO", "REV", "KHW", 'CVW', "SUN", "NEW", "MFW", "ASS", "EPW"))
data$prj <- matchdf$nameShort[match(data$group, matchdf$nameLong)]
data$dev <- metaData$Developer[match(data$prj, metaData$prjCode)]

#Custom Colors
category_colors <- c(
'SAP' = "#42d4f4",#
'COP Submit' = "#3cb44b",#
'COP Other' = "#aaffc3",
'DEIS Release' = "#800000",#
'Comment End' = "#a9a9a9",
'NOI EIS' = "#dcbeff",#
'COP Approval' = "#ffe119",#
'ROD Release' = "#f58231",#
'FEIS Release' = "#e6194B",#
'COP Update' = "#bfef45",
'Other' = "#000000"
)

#Ploting
tl<-ggplot(data, aes(start, group, color = color, size = size))+
  geom_point()+
  scale_size(guide = "none") +
  scale_color_manual(values = category_colors) +
  theme_linedraw()+
  geom_vline(xintercept = as.Date("2023-07-18"), linetype = "dashed", color = "black")+
  labs(title = "", x = '', y='', color = "")

ggsave("./SavedFigs/Fig1_2.png", tl, height = 4.5, width = 10, bg = "white")
tl
```

## Figure 2: Counts of all line items

```{r, warning=FALSE, message=FALSE, tidy=TRUE,cache=FALSE}
library(openxlsx) 
library(ggplot2)
library(ggrepel)
library(ggbreak) 
library(patchwork)
library(dplyr)
library(stringr)
library(lubridate)
library(readxl)
library(gtable)
library(gridExtra)

classData <- read_excel("./ClassificationData.xlsx", sheet = 1) #Classification Dat
metaData <- read_excel("./ClassificationData.xlsx", sheet = 2) #Meta

#Creating Project col
classData$prj <- substr(classData$Code,1,3)
#classData$comit <- as.numeric(substr(classData$Code,4,4)) #Section

#Date Manipulation
classData$date <- metaData$prjDate[match(classData$prj, metaData$prjCode)]
classData$date <- as.Date(classData$date, format = "%m/%d/%Y")
#Getting Counts
lineCounts <- sort(table(classData$prj))

#Assigning Metadata to line counts
  count_df <- data.frame(Prj = names(lineCounts), Count = as.vector(lineCounts))
  count_df$date <- metaData$prjDate[match(count_df$Prj, metaData$prjCode)]
  count_df$Dev <- metaData$Developer[match(count_df$Prj, metaData$prjCode)]
  count_df$Doc <- metaData$DocType[match(count_df$Prj, metaData$prjCode)]
  count_df$Consult <- metaData$Consultantcy[match(count_df$Prj, metaData$prjCode)]
  #Changing the date of BIW to an earlier day for better comparison
  count_df$date[count_df$Prj == "BIW"] <- as.character('10/01/2020')
  
  count_df$date <- as.Date(count_df$date, format = "%m/%d/%Y")
  count_df <- data.frame(count_df[order(count_df$date),], row.names = NULL)
  #Getting Year into a more comprehensable format for the line of best fit
  count_df$yr <- decimal_date(count_df$date) 
  
  #Generating a line of best fit for all non BIW points
  lm_model <- lm(count_df$Count[count_df$Prj != "BIW"] ~ count_df$yr[count_df$Prj != "BIW"])
  slope <- coef(lm_model)[2]
  intercept <- coef(lm_model)[1]
  line_formula <- paste("y =", round(slope, 2), "x +", round(intercept, 0))
  count_df$pred[count_df$Prj != "BIW"] <- predict(lm_model)
  
  #Plotting
  plt<-ggplot(count_df, aes(date, Count, label = Prj, color = Dev, shape = Doc))+
    geom_point()+ geom_text_repel(show.legend = FALSE)+theme_classic()+
    geom_line(aes(date, pred, label=NULL, shape=NULL), color='black')+
    geom_text(aes(x = min(date), y = max(Count), label = line_formula),
              hjust = -0.1, vjust = 2, color = "black", size = 4) +
    labs(title = NULL, x ="Document release date", y = "Count", color = "Developer", shape = "Document")
  #Adding back Arrow for BIW
  plt<-plt + geom_segment(aes(
      x=date[Prj == "BIW"], 
      y=Count[Prj == "BIW"], 
      xend=as.Date(-Inf), 
      yend=Count[Prj == "BIW"]),
      color = 'black',
      arrow = arrow(length=unit(0.5, 'cm')))
  
#Making Figure
width <- 8
height <- width*10/16
ggsave("./SavedFigs/fig2.png", plt, height = height, width =width, dpi = 300)
plt
```

## Figure 3: Protected Resource

```{r, warning=FALSE, message=FALSE, tidy=TRUE,cache=FALSE}
library(openxlsx) 
library(ggplot2)
library(ggrepel)
library(ggbreak) 
library(patchwork)
library(dplyr)
library(stringr)
library(lubridate)
library(readxl)
library(gtable)
library(gridExtra)
library(tidyr)

#Importing Data
classData <- read_excel("./ClassificationData.xlsx", sheet = 1) #Classification Dat
metaData <- read_excel("./ClassificationData.xlsx", sheet = 2) #Meta
classData$prj <- substr(classData$Code,1,3) #Project Info


#List of Protected Resource
recource <- c("MarineMams", "Turts", "Birds", "Bats", "Benthic", "AirQ", "WaterQ", "AcouAbove", "AcouBelow","Fish", "EssFishHabs", "CultArcheo", "CoastalHabs", "WetLands", "RecTourism", "RecComFisheries","VesselNav", "SocioEcon", "EnviroJustice", "PubHealth", "Visual", "FAA-DOD","Other")

#Seperating Tags
data_sep_tags <- classData %>%
  separate_rows(Prot, sep = ", ")

# Group the data by project and tag, and then counting for n
tag_counts <- data_sep_tags %>%
  group_by(prj, Prot) %>%
  summarize(count = n())

fullCount <- data_sep_tags %>%
  group_by(prj) %>%
  summarize(count = n())
#Filling in 0 counts
all_combinations <- expand.grid(
  prj = unique(tag_counts$prj),
  Prot = recource
)
tagCounts <- all_combinations %>%
  left_join(tag_counts, by = c("prj", "Prot")) %>%
  replace_na(list(count = 0))

#Calculating Frequency of a tag showing up
tagCounts$prec <- tagCounts$count / fullCount$count[match(tagCounts$prj, fullCount$prj)]

#Ordering y axis by the mean frequency of a tag
Rank <- tagCounts %>%
  group_by(Prot) %>%
  summarize(count = mean(prec))
tagCounts$Prot <- factor(tagCounts$Prot, levels = first( list(Rank$Prot[order(Rank$count)])   ))

#Ordering X axis by project sap start date
# tagCounts$prj <- factor(tagCounts$prj, levels = c("BIW", "YVW", "SFR", "OWO", "REV", "KHW", 'CVW', "SUN", "NEW", "MFW", "ASS", "EPW"))
tagCounts$prj <- factor(tagCounts$prj, levels = c('BIW','CVW', "REV", "SFR", "YVW", "OWO", "NEW", "EPW", "KHW", "SUN", "ASS", "MFW")
)

#Plotting
plt <- ggplot(tagCounts, aes(prj, Prot, size = prec, color = prec))+
  scale_color_gradient(low = "blue", high = "red") +
  labs(title = NULL,x=NULL, y=NULL, color = 'Freq\nof Tag')+
  geom_point()+  guides(size = 'none')+
  theme_minimal()+
  theme(legend.position ='bottom', axis.text.x = element_text(angle = 90, hjust = 1))

width <- 6
height <- width*10/12

ggsave("./SavedFigs/fig3.png", plt, height = width, width =height, dpi = 300)
plt
```

## Figure 4: Monitoring and Mitigation

```{r, warning=FALSE, message=FALSE, tidy=TRUE,cache=FALSE}
library(openxlsx) 
library(ggplot2)
library(ggrepel)

#Importing  Data
classData <- read_excel("./ClassificationData.xlsx", sheet = 1) #Classification Dat
metaData <- read_excel("./ClassificationData.xlsx", sheet = 2) #Meta
classData$prj <- substr(classData$Code,1,3) #Project Info

#Subsetting by mon/mit
classData_Mon <- classData[classData$Mon == TRUE, ]
classData_Mit <- classData[classData$Mit == TRUE, ]

#Counting Occurances of Mon/Mit for each project
lineCountX <- table(classData_Mon$prj)
lineCountY <- table(classData_Mit$prj)

#Stringing these together
count_df <- data.frame(Prj = names(lineCountX), CountX = as.vector(lineCountX),  CountY = as.vector(lineCountY))
  
#Adding Project information
count_df$date <- metaData$prjDate[match(count_df$Prj, metaData$prjCode)]
count_df$Dev <- metaData$Developer[match(count_df$Prj, metaData$prjCode)]
count_df$Doc <- metaData$DocType[match(count_df$Prj, metaData$prjCode)]
count_df$Consult <- metaData$Consultantcy[match(count_df$Prj, metaData$prjCode)]

#Plotting
plt<-ggplot(count_df, aes(CountX, CountY, label = Prj, color = Dev, shape = Doc))+
  geom_abline(slope = 5, intercept = 0, color = "red", linetype = "dashed")+
  geom_point()+ geom_text_repel(show.legend = FALSE, force = 3)+theme_classic()+
  labs(title = NULL, x ="Monitoring Measures", y = "Mitigation Measures", color = "Developer", shape = "Document")

#Saving Figure
width <- 6
height <- width*10/16
ggsave("./SavedFigs/fig4.png", plt, height = height, width =width, dpi = 300)
plt
```

## Figure 5: Above and Below Water

```{r, warning=FALSE, message=FALSE, tidy=TRUE,cache=FALSE}
library(openxlsx) 
library(ggplot2)
library(ggrepel)

#Importing  Data
classData <- read_excel("./ClassificationData.xlsx", sheet = 1) #Classification Dat
metaData <- read_excel("./ClassificationData.xlsx", sheet = 2) #Meta
classData$prj <- substr(classData$Code,1,3) #Project Info

#Creating Above and Below Subsets
AbBl <- c('AboveWater', "BelowWater")
for (r in AbBl){
  classData_r <- classData[sapply(classData$AB, function(x) any(grepl(r, unlist(strsplit(x, ","))))), ]
  ifelse(r == 'AboveWater', classData_Ab <- classData_r, classData_Bl <- classData_r )
}

#Counting Above and Below
lineCountX <- table(classData_Ab$prj)
lineCountY <- table(classData_Bl$prj)

#Splicing 
count_df <- data.frame(Prj = names(lineCountX), CountX = as.vector(lineCountX), CountY = as.vector(lineCountY))
count_df$date <- metaData$prjDate[match(count_df$Prj, metaData$prjCode)]
count_df$Dev <- metaData$Developer[match(count_df$Prj, metaData$prjCode)]
count_df$Doc <- metaData$DocType[match(count_df$Prj, metaData$prjCode)]
count_df$Consult <- metaData$Consultantcy[match(count_df$Prj, metaData$prjCode)]

#Plotting
plt<-ggplot(count_df, aes(CountX, CountY, label = Prj, color = Dev, shape = Doc))+
  geom_point()+ geom_text_repel(show.legend = FALSE)+theme_classic()+
  labs(title = NULL, x ="Above Water measures", y = "Below Water measures", color = "Developer", shape = "Document")+ 
  geom_abline(slope = 1, intercept = 0, color = "red", linetype = "dashed")

#Saving Figure
width <- 6
height <- width*10/16
ggsave("./SavedFigs/fig5.png", plt, height = height, width =width, dpi = 300)
plt
```

## Figure 6: DEIS vs FEIS

```{r, warning=FALSE, message=FALSE, tidy=TRUE,cache=FALSE}
library(dplyr)
library(ggplot2)
library(ggpubr)
library(cowplot)
#Line Item Counts as a precentage of their whole
difData2 <- data.frame(prj = c('Revolution Wind', "South Fork", "Vineyard Wind", "Ocean Winds 1", 'Revolution Wind', "South Fork", "Vineyard Wind", "Ocean Winds 1"),
                       Count = c(199/333, 173/202,33/98, 294/314, 134/333, 29/202, 65/98, 20/314),
                       Doc = c('DEIS', 'DEIS','DEIS','DEIS', 'FEIS','FEIS','FEIS','FEIS'))

#Organizing by FEIS Release Date Order
difData2$prj2 <- factor(difData2$prj, levels = c("Vineyard Wind", "South Fork","Ocean Winds 1", 'Revolution Wind'))

#Making things pretty
difData2$Doc <- factor(difData2$Doc, levels = rev(c('DEIS', 'FEIS')))
difData2$Count <- difData2$Count*100

#Plotting
p2<-ggplot(difData2, aes(prj2, Count, fill = Doc))+ 
  geom_bar(stat = 'identity')+
  labs(title = NULL, x = "Project (in FEIS release date order)", y = "%", fill = NULL)+
  theme_classic()
#gabbing legend / removing from original plot
legend_gtable <- get_legend(p2)
p2<-p2 + theme(legend.position = 'none')

#Combined Picture
fig6<-ggdraw()+
  draw_plot(p2,x = 0,y = 0,width = 1,height = 1)+
  draw_plot(legend_gtable, x=.78, y=.12, width = .15, height=.15)

#Saving
width <- 8
height <- width*10/16
ggsave("./SavedFigs/fig6.png", fig6, height = height, width =width, dpi = 300)
fig6
```

## Figure 7: Average Precentage Anomaly Calculated from counts of Redundant line items compared to total project line items

```{r, warning=FALSE, message=FALSE, tidy=TRUE,cache=FALSE}
data <- read_excel("./ClassificationData.xlsx", sheet = 1) #Classification Dat
metaData <- read_excel("./ClassificationData.xlsx", sheet = 2) #Meta
data$prj <- substr(data$Code,1,3) #Project Info

#Removing Project Specific Line items - 
data$Name[is.na(data$Name)] <- 'Prj Specific'
data_ful<-data # Copy for line counts later
data <- data[!(data$Name == 'Prj Specific') , ]

#Getting The count of each redundancy point by project
result <- data %>%
  group_by(Name, prj) %>%
  summarize(count = n()) 

# Create a data frame with all combinations of unique Name and prj values - to fill in 0 values
all_combinations <- expand.grid(
  Name = unique(data$Name),
  prj = unique(data$prj)
)
result <- all_combinations %>%
  left_join(result, by = c("Name", "prj")) %>%
  mutate(count = coalesce(count, 0))

#Getting the mean of each Redundancy Point across all projects
totals <- result %>%
  group_by(Name) %>%
  summarize(mean = mean(count))

#Calculating Anomolie from the mean for each project and each catigory and the precentage difference -1 to 1
result$anom <- result$count - totals$mean[match(result$Name, totals$Name)]
result$anomPrec <- (result$count - totals$mean[match(result$Name, totals$Name)]) / (totals$mean[match(result$Name, totals$Name)])
result$prj <- factor(result$prj, levels = c("BIW", "YVW", "SFR", "OWO", "REV", "KHW", 'CVW', "SUN", "NEW", "MFW", "ASS", "EPW"))

#Taking the average of the %anomolies 
AvgAnom <- result %>% group_by(prj) %>%
  summarise(mean = mean(anomPrec))

#Getting Project line item counts - and adding them to AvgAnom
AllCounts <- data_ful %>% group_by(prj) %>%
  summarise(count = n())
AvgAnom$count <- AllCounts$count[match(AvgAnom$prj, AllCounts$prj)]
AvgAnom$dev <- metaData$Developer[match(AvgAnom$prj, metaData$prjCode)]

#Generating information about the line of best fit
lm_model <- lm(AvgAnom$mean ~ AvgAnom$count)
slope <- coef(lm_model)[2]
intercept <- coef(lm_model)[1]
line_formula <- paste("y =", round(slope, 4), "* x +", round(intercept, 2))

#Plotting this relatioship - "Average Precentage Anomaly Calculated from counts of Redundant \nline items compared to total project line items"
fig7 <- ggplot(AvgAnom, aes(count, mean))+ 
  geom_smooth(method = lm, se = FALSE, formula = 'y ~ x', color = 'black')+
  geom_point(aes(color = dev))+
  geom_text_repel(aes(label = prj, color = dev), show.legend = F, force = 3)+
  geom_text(aes(x = -Inf, y = Inf, label = line_formula),
            hjust = -0.1, vjust = 2, color = "black", size = 3) +
  theme_classic()+
  labs(title = NULL, y ="Avg % Anomaly", x = "Total Project Line items", color = NULL)

#Saving Fig
width <- 6
height <- width*10/16
ggsave("./SavedFigs/fig7.png", fig7, height = height, width =width, dpi = 300)
fig7
```

## Figure 8: Tile Plot of redundancy

```{r, warning=FALSE, message=FALSE, tidy=TRUE,cache=FALSE}
#Still gotta do this...
#How do we make this have meaning/significance
```
